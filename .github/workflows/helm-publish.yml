name: Helm Publish

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - '.git*'
      - 'README.md'
  push:
    branches:
      - 'main'
    paths-ignore:
      - '.git*'
      - 'README.md'
  workflow_dispatch: {}

env:
  CHARTS_PATH: "charts/"
  REGISTRY: "ghcr.io/${{ github.repository }}"

jobs:
  helm:
    permissions:
      contents: write
      packages: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.18.6
      - name: Setup yq
        uses: dcarbone/install-yq-action@v1
        with:
          version: 'v4.44.3'
      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
      - name: Publish
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${REGISTRY} --username ${GITHUB_ACTOR} --password-stdin
          for d in ${CHARTS_PATH}*/ ; do
            if [[ ! -f "${d}Chart.yaml" ]]; then
                echo "${d}Chart.yaml not found. Skipping."
                continue
            fi
            rcVersion="false"
            chartName=$(yq '.name' "$d/Chart.yaml")
            currentVersion=$(yq '.version' "$d/Chart.yaml")
            chartRepositoryPath="oci://$REGISTRY/$chartName"
            echo "üîÑ Processing chart $chartName and version $currentVersion"
            if [[ $currentVersion == *"rc"* ]] && [ "${{ github.event_name }}" == "pull_request" ]; then rcVersion="true"; fi
            if [[ $rcVersion == "true" ]] || [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
              echo "Checking release for chart $chartName and current file version $currentVersion"
              set +e  # Disable exit on error
              helm pull "$chartRepositoryPath" --version "$currentVersion"
              chartReleased=$?
              set -e  # Enable exit on error
              if [ $chartReleased -eq 0 ]; then
                echo "ü¶ò $chartName version already released [skipping]"
              else
                echo "üì¶ Packaging chart $chartName and version $currentVersion"
                helm dep update "$d"
                helm package "$d" -u -d "${d}"
                chartVersionName="$chartName-$currentVersion"
                chartPackageName="$chartVersionName.tgz"
                echo "Pushing chart $chartPackageName"
                helm push "${d}$chartPackageName" oci://${REGISTRY,,}
                echo "üéâ Chart $chartPackageName pushed successfully"
                if [[ $rcVersion == "false" ]]; then
                  echo "üìå Creating git tag $chartVersionName"
                  git tag -a "$chartVersionName" -m "Release $chartVersionName"
                  git push origin "$chartVersionName"
                  echo "‚úÖ Git tag $chartVersionName created and pushed"
                  echo "üìù Creating GitHub release for $chartVersionName"
                  changelogUrl="https://github.com/${{ github.repository }}/blob/main/charts/$chartName/CHANGELOG.md"
                  releaseBody="See changelog here: [$chartName CHANGELOG.md]($changelogUrl)"
                  gh release create "$chartVersionName" \
                    --title "Release $chartVersionName" \
                    --notes "$releaseBody" \
                    --repo "${{ github.repository }}"
                  echo "‚úÖ GitHub release $chartVersionName created successfully"
                else
                  echo "‚è≠Ô∏è  Skipping git tag creation for RC version"
                fi
              fi
            fi
          done
      - name: Publish Index
        if: github.ref == 'refs/heads/main'
        uses: helm/chart-releaser-action@v1.7.0
        env:
          CR_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
