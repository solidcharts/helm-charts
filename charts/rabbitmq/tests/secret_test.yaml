suite: test secret
templates:
  - secret.yaml
tests:
  - it: should skip secret generation when provided existing secret keys
    set:
      auth:
        existingPasswordSecret: "rabbit-credentials"
        existingPasswordSecretKey: "password"
        existingErlangCookieSecret: "rabbit-credentials"
        existingErlangCookieSecretKey: "erlang-cookie"
    asserts:
      - hasDocuments:
          count: 0
  - it: should generate random secrets when no existing secret keys are provided
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - matchRegex:
          path: metadata.name
          pattern: RELEASE-NAME-rabbitmq
      - exists:
          path: data.password
      - exists:
          path: data.erlang-cookie
  - it: should generate only erlang-cookie when existing password secret key is provided
    set:
      auth:
        existingPasswordSecret: "rabbit-credentials"
        existingPasswordSecretKey: "password"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - matchRegex:
          path: metadata.name
          pattern: RELEASE-NAME-rabbitmq
      - notExists:
          path: data.password
      - exists:
          path: data.erlang-cookie
  - it: should generate only password when existing erlang cookie secret key is provided
    set:
      auth:
        existingErlangCookieSecret: "rabbit-credentials"
        existingErlangCookieSecretKey: "erlang-cookie"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - matchRegex:
          path: metadata.name
          pattern: RELEASE-NAME-rabbitmq
      - notExists:
          path: data.erlang-cookie
      - exists:
          path: data.password
